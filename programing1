import tkinter as tk
import random
from PIL import Image, ImageTk

WINDOW_HEIGHT = 600  # ウィンドウの高さ
WINDOW_WIDTH = 600   # ウィンドウの幅

CANNON_Y = 550       # 自機のy座標

ENEMY_SPACE_X = 100  # 敵の間隔(x座標)
ENEMY_SPACE_Y = 60   # 敵の間隔(y座標)
ENEMY_MOVE_SPACE_X = 20  # 敵の移動間隔(x座標)
ENEMY_MOVE_SPEED = 2000  # 敵の移動スピード(2000 ms)
NUMBER_OF_ENEMY = 18     # 敵の数
ENEMY_SHOOT_INTERVAL = 200  # 敵がランダムに弾を打ってくる間隔

COLLISION_DETECTION = 300  # 当たり判定

BULLET_HEIGHT = 10  # 弾の縦幅
BULLET_WIDTH = 2    # 弾の横幅
BULLET_SPEED = 10   # 弾のスピード(10 ms)

TEXT_GOOD_SIZE = 10             # goodのサイズ
TEXT_CONGRATULATIONS_SIZE = 50  # congratularionsのサイズ
TEXT_GAMECLEAR_SIZE = 60        # gameclearのサイズ
TEXT_GAMEOVER_SIZE = 90         # gameoverのサイズ


class Cannon:  # 自機

    def __init__(self, x, y=CANNON_Y):
        self.x = x
        self.y = y
        self.draw()
        self.bind()

    def draw(self):
        self.id = cv.create_image(
            self.x, self.y, image=cannon_tkimg, tag="cannon")

    def bind(self):
        cv.tag_bind(self.id, "<ButtonPress-3>", self.pressed)
        cv.tag_bind(self.id, "<Button1-Motion>", self.dragged)

    def pressed(self, event):
        mybullet = MyBullet(event.x, self.y)
        mybullet.draw()
        mybullet.shoot()

    def dragged(self, event):
        dx = event.x - self.x
        self.x, self.y = cv.coords(self.id)
        cv.coords(self.id, self.x+dx, self.y)
        self.x = event.x

    def destroy(self):
        cv.delete(self.id)


class MyBullet:  # 自分の弾

    def __init__(self, x, y):
        self.x = x
        self.y = y

    def draw(self):
        self.id = cv.create_rectangle(
            self.x-BULLET_WIDTH, self.y+BULLET_HEIGHT, self.x+BULLET_WIDTH, self.y-BULLET_HEIGHT, fill="blue")

    def shoot(self):
        if self.y >= 0:
            cv.move(self.id, 0, -BULLET_HEIGHT)
            self.y -= BULLET_HEIGHT
            self.defeat()
            root.after(BULLET_SPEED, self.shoot)

    def defeat(self):
        for enemy in enemies:
            if ((self.x-enemy.x)**2+(self.y-enemy.y)**2) < COLLISION_DETECTION:
                enemy.exist = False
                enemy.destroy()
                cv.create_text(enemy.x, enemy.y, text="good!", fill="cyan", font=(
                    "System", TEXT_GOOD_SIZE), tag="good")

    def destroy(self):
        cv.delete(self.id)


class Enemy:  # 的

    def __init__(self, x, y):
        self.x = x % WINDOW_WIDTH
        self.y = y+x//WINDOW_WIDTH*ENEMY_SPACE_Y
        self.exist = True
        self.draw()
        self.move()

    def draw(self):
        self.id = cv.create_image(
            self.x, self.y, image=crab_tkimg, tag="enemy")

    def move(self):
        if self.exist:
            if self.x > WINDOW_WIDTH:
                self.x -= ENEMY_MOVE_SPACE_X
                self.y += ENEMY_SPACE_Y
            elif self.x < 0:
                self.x += ENEMY_MOVE_SPACE_X
                self.y += ENEMY_SPACE_Y
            if self.y % (ENEMY_SPACE_Y*2) == ENEMY_SPACE_Y:
                self.x += ENEMY_MOVE_SPACE_X
            else:
                self.x -= ENEMY_MOVE_SPACE_X
            cv.coords(self.id, self.x, self.y)
            root.after(ENEMY_MOVE_SPEED, self.move)

    def destroy(self):
        cv.delete(self.id)

def gamefinish():  # ゲームクリア判定
    global cv
    cv.delete("cannon","good")
    cv.create_text(WINDOW_WIDTH//2, WINDOW_HEIGHT//2+20, text="GAME FINISH!",
                   fill="lime", font=("System", TEXT_GAMECLEAR_SIZE),tags="clear")
    root.after(2000, show_result_frame) # 2秒後にリザルトフレームに移行 
  

def start_game():
    global cv, cannon, enemies

    menu_frame.pack_forget()
    result_frame.pack_forget()
    game_frame.pack()

    # 初期描画
    cv = tk.Canvas(game_frame, width=WINDOW_WIDTH, height=WINDOW_HEIGHT, bg="black")
    cv.pack()

    # 画像の読み込み
    global cannon_tkimg, crab_tkimg
    cannon_img = Image.open("cannon.jpg")
    cannon_tkimg = ImageTk.PhotoImage(cannon_img)
    crab_img = Image.open("crab.jpg")
    crab_tkimg = ImageTk.PhotoImage(crab_img)

    # インスタンス生成
    cannon = Cannon(WINDOW_WIDTH//2, CANNON_Y)
    enemies = []
    for i in range(NUMBER_OF_ENEMY):
        enemy_i = Enemy(i*ENEMY_SPACE_X+50, ENEMY_SPACE_Y)
        enemies.append(enemy_i)

    root.after(10000, gamefinish) # 10秒後にゲームクリア判定を実行

def show_result_frame():
    game_frame.pack_forget()
    result_frame.pack()

def back_to_menu():
    result_frame.pack_forget()
    game_frame.pack_forget()
    menu_frame.pack()


if __name__ == "__main__":
    root = tk.Tk()
    root.title("invader")

    # メニューフレーム
    menu_frame = tk.Frame(root, width=WINDOW_WIDTH, height=WINDOW_HEIGHT,bg="black")
    menu_frame.pack_propagate(False)
    menu_frame.pack()

    start_button = tk.Button(menu_frame, text="START", command=start_game)
    start_button.pack(pady=20)

    # ゲームフレーム
    game_frame = tk.Frame(root, width=WINDOW_WIDTH, height=WINDOW_HEIGHT)

    # リザルトフレーム
    result_frame = tk.Frame(root, width=WINDOW_WIDTH, height=WINDOW_HEIGHT,bg="black")
    result_frame.pack_propagate(False)  # サイズ固定
    menu_button = tk.Button(result_frame, text="menu", command=back_to_menu)
    menu_button.pack(pady=20)

    # メニューバー
    menubar = tk.Menu(root)
    root.configure(menu=menubar)
    menubar.add_command(label="QUIT", underline=0, command=root.quit)

    root.mainloop()
